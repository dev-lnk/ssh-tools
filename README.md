# SSH Tools - Инструменты для настройки серверов

Набор bash скриптов для автоматической настройки удаленных серверов Ubuntu 24.04 через SSH.

## Возможности

### init.sh - Первоначальная настройка сервера
- ✓ Автоматическое обновление пакетов
- ✓ Создание нового sudo пользователя
- ✓ Настройка SSH ключей
- ✓ Отключение входа по паролю
- ✓ Установка и настройка Fail2ban
- ✓ Изменение SSH порта
- ✓ Полностью автоматический процесс (без подтверждений)

## Быстрый страт
Продвинутый пользователь может посмотреть в .env.example и сразу разобраться, что нужно сделать.
- Создать .env, вбить необходимые данные
- Выполнить `./init.sh`. 

Далее будет подробная инструкция.

## Требования

### На локальной машине:
- Ubuntu/Debian или WSL с Ubuntu
- `sshpass` установлен
- SSH ключ (id_rsa.pub или id_ed25519.pub)

### На удаленном сервере:
- Ubuntu 24.04
- SSH доступ с паролем (временно)
- Root доступ или пользователь с sudo правами

## Установка

1. Установите `sshpass` на локальной машине:
```bash
sudo apt-get update
sudo apt-get install sshpass
```

2. Клонируйте репозиторий или скопируйте файлы

3. Скопируйте `.env.example` в `.env`:
```bash
cp .env.example .env
```

4. Отредактируйте `.env` файл и заполните все необходимые параметры:

## Конфигурация

Откройте `.env` и установите следующие параметры:

- `USER` - пользователь для первого подключения (обычно `root`)
- `INIT_PORT` - текущий SSH порт (обычно `22`)
- `SERVER_HOST` - IP адрес или домен вашего сервера
- `INIT_PASS` - пароль для первого подключения
- `NEW_USER` - имя нового пользователя с sudo правами
- `NEW_USER_PASS` - пароль для нового пользователя
- `PUBLIC_KEY` - содержимое вашего публичного SSH ключа (так же будет добавлен к пользователю root)
- `NEW_SSH_PORT` - новый SSH порт (рекомендуется не 22)
- `URL` - доменное имя для сайта (например, example.com) - для angie.sh
- `ACME_EMAIL` - email для SSL сертификатов ACME - для angie.sh

### Получение публичного ключа

Если у вас еще нет SSH ключа:
```bash
# Создание нового SSH ключа
ssh-keygen -t ed25519 -C "your_email@example.com"
```

Скопируйте содержимое публичного ключа:
```bash
cat ~/.ssh/id_ed25519.pub
# или
cat ~/.ssh/id_rsa.pub
```

## Использование

### Первоначальная настройка сервера (init.sh)

Запустите скрипт для первоначальной настройки:
```bash
./init.sh
```

Скрипт выполнит все действия автоматически:
1. Проверит наличие `.env` файла
2. Подключится к серверу
3. Обновит все пакеты
4. Создаст нового sudo пользователя
5. Настроит SSH ключи для обоих пользователей
6. Отключит вход по паролю
7. Установит и настроит Fail2ban
8. Изменит SSH порт
9. Перезапустит службы

## angie.sh - Установка веб-сервера Angie с ACME (пока не работает)
- ✓ Автоматическая установка Angie с модулем ACME
- ✓ Создание структуры сайта
- ✓ Настройка HTTPS с автоматическим получением SSL сертификатов
- ✓ Автоматическое обновление сертификатов (cron)
- ✓ Настройка безопасности (заголовки, редиректы)
- 
### Установка веб-сервера Angie (angie.sh)

После первоначальной настройки сервера, установите Angie:
```bash
./angie.sh
```

Скрипт выполнит:
1. Подключится к серверу по SSH ключу
2. Установит Angie с модулем ACME
3. Создаст структуру сайта в `/var/www/URL`
4. Настроит конфигурацию для HTTP/HTTPS
5. Настроит автоматическое получение SSL сертификатов
6. Создаст тестовую страницу "Hello World"
7. Настроит автоматическое обновление сертификатов (cron)

## После выполнения

После успешной настройки:

1. Подключайтесь к серверу используя новый порт:
```bash
ssh -p NEW_SSH_PORT NEW_USER@SERVER_HOST
```

2. **ВАЖНО**: Перед закрытием текущей сессии убедитесь, что можете подключиться с новым пользователем и SSH ключом!

3. Рекомендуется сохранить конфигурацию в `~/.ssh/config`:
```
Host myserver
    HostName SERVER_HOST
    Port NEW_SSH_PORT
    User NEW_USER
    IdentityFile ~/.ssh/id_ed25519
```

Тогда вы сможете подключаться просто: `ssh myserver`

### После установки Angie (angie.sh)

1. Убедитесь что DNS записи для вашего домена указывают на IP сервера
2. Откройте в браузере: `https://your-domain.com`
3. SSL сертификат будет получен автоматически при первом HTTPS запросе
4. Сертификаты будут автоматически обновляться через cron (каждый день в 2:00)

Конфигурационные файлы:
- Основная конфигурация: `/etc/angie/http.d/URL.conf`
- ACME конфигурация: `/etc/angie/http.d/URL-acme.conf`
- SSL сертификаты: `/etc/angie/ssl/URL/`
- Файлы сайта: `/var/www/URL/`
- Логи: `/var/log/angie/URL-access.log` и `/var/log/angie/URL-error.log`

## Безопасность
- ✓ После настройки вход по паролю будет отключен
- ✓ Fail2ban защитит от брутфорс атак (максимум 5 попыток)

## Решение проблем

### sshpass не установлен
```bash
sudo apt-get install sshpass
```

### Ошибка подключения
- Проверьте правильность SERVER_HOST, USER, INIT_PORT
- Убедитесь что сервер доступен: `ping SERVER_HOST`
- Проверьте что SSH работает: `telnet SERVER_HOST INIT_PORT`

### Неправильный пароль
- Проверьте INIT_PASS в `.env` файле
- Убедитесь что нет лишних пробелов

